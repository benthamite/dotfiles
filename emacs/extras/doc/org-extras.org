#+title: org-extras: Extensions for Org Mode
#+author: Pablo Stafforini
#+email: pablo@stafforini.com
#+language: en
#+options: ':t toc:t author:t email:t num:t
#+startup: content
#+export_file_name: org-extras.info
#+texinfo_filename: org-extras.info
#+texinfo_dir_category: Emacs misc features
#+texinfo_dir_title: Org Extras: (org-extras)
#+texinfo_dir_desc: Extensions for Org Mode

This manual describes the features and customization options for the Emacs Lisp file =org-extras.el=.

* Overview
:PROPERTIES:
:CUSTOM_ID: h:overview
:END:

=org-extras.el= provides a wide array of extensions for Emacs' Org mode. These extensions enhance navigation, editing, linking, clocking, agenda management, capture, folding, ID management, list handling, refiling, Babel evaluation, encryption, and integration with external tools like Pandoc and Google Drive.

The main features include:

- **Editing & Navigation:** Setting TODO properties (priority, effort), copying URLs/links/descriptions, inserting subheadings, copying heading content/name, counting words in subtrees, jumping to first heading, enhanced RET behavior on links.
- **Clipboard & Conversion:** Pasting clipboard content converted to Org (from HTML/Markdown via Pandoc), pasting clipboard image as a linked file.
- **Display:** Toggling inline image display.
- **Agenda:** Switching to today's agenda view, clocking in from agenda, postponing tasks, DWIM switching between agenda and source file, toggling anniversary display.
- **Capture:** A comprehensive =org-capture-before-finalize-hook= function performing various actions based on capture template key (tagging, dictionary setting, linking, renaming prompts, etc.).
- **Clocking:** Inserting new clock entries, various timestamp insertion commands, jumping to latest clock entry, inserting clock reports with configurable scope/range, deleting headings without logbooks, custom clocktable sorting.
- **Meeting Participants:** Automatically prompting for and adding participant links to headings when clocking in (configurable exclusion).
- **Folding & Cycling:** Enhanced global cycling that hides archives, commands to show all headings/properties/logbooks.
- **ID Management:** Automatically adding Org IDs to headings in specified files/directories (with exclusions), command to update ID locations across multiple sources.
- **List Handling:** Completing checkboxes and moving to the next item, resetting checkbox states in subtrees.
- **Refiling:** Refiling to specific buffer positions, jumping to latest refiled item, refiling and archiving in one step, regenerating refile cache.
- **Linking & Sorting:** Sorting lists of Org links, linkifying elements in a list based on Org Roam nodes.
- **Babel:** Confirmation function for evaluating specific languages, command to save and tangle.
- **Encryption:** DWIM command to decrypt entry or evaluate time range if on a clock line.
- **Narrowing:** DWIM narrowing (subtree, region, source block, defun), narrowing to entry with/without children.
- **Misc:** Getting heading text start position, importing Google Docs via Pandoc, removing trailing empty headings, transient menus for personal/project navigation.

* User Options
:PROPERTIES:
:CUSTOM_ID: h:user-options
:END:

** ~org-extras-agenda-files-excluded~
:PROPERTIES:
:CUSTOM_ID: h:org-extras-agenda-files-excluded
:END:

#+vindex: org-extras-agenda-files-excluded
A list of file paths (strings) to be excluded from Org Agenda generation. Useful for preventing files without specific agenda tags but potentially containing TODOs or logs from cluttering the agenda view.

** ~org-extras-id-auto-add-excluded-directories~
:PROPERTIES:
:CUSTOM_ID: h:org-extras-id-auto-add-excluded-directories
:END:

#+vindex: org-extras-id-auto-add-excluded-directories
A list of directory paths (strings) where ~org-extras-id-auto-add-ids-to-headings-in-file~ should *not* automatically add IDs.

** ~org-extras-id-auto-add-excluded-files~
:PROPERTIES:
:CUSTOM_ID: h:org-extras-id-auto-add-excluded-files
:END:

#+vindex: org-extras-id-auto-add-excluded-files
A list of file paths or patterns (strings) to exclude from automatic ID addition by ~org-extras-id-auto-add-ids-to-headings-in-file~. If set to t, disables automatic ID addition for all files.

** ~org-extras-id-auto-add-excluded-headings~
:PROPERTIES:
:CUSTOM_ID: h:org-extras-id-auto-add-excluded-headings
:END:

#+vindex: org-extras-id-auto-add-excluded-headings
A list of heading titles (strings) to exclude from automatic ID addition by ~org-extras-id-auto-add-ids-to-headings-in-file~ (e.g., "Local variables").

** ~org-extras-bbdb-anniversaries-heading~
:PROPERTIES:
:CUSTOM_ID: h:org-extras-bbdb-anniversaries-heading
:END:

#+vindex: org-extras-bbdb-anniversaries-heading
The Org ID (string) of the heading in =calendar.org= (or equivalent) that contains BBDB anniversary entries generated by =org-bbdb-anniversaries=. Used by ~org-extras-agenda-toggle-anniversaries~. Set to nil to disable the toggle functionality.

** ~org-extras-clock-report-parameters~
:PROPERTIES:
:CUSTOM_ID: h:org-extras-clock-report-parameters
:END:

#+vindex: org-extras-clock-report-parameters
A format string used by ~org-extras-clock-report-insert~ to generate the =#+BEGIN: clocktable= line. Includes placeholders for scope and date range.

** ~org-extras-clock-in-add-participants-exclude~
:PROPERTIES:
:CUSTOM_ID: h:org-extras-clock-in-add-participants-exclude
:END:

#+vindex: org-extras-clock-in-add-participants-exclude
A regexp (string). If the heading being clocked into matches this regexp, the user will *not* be prompted to add participants by the ~org-extras-clock-in-add-participants~ advice.

** ~org-extras-confirm-babel-evaluate-languages~
:PROPERTIES:
:CUSTOM_ID: h:org-extras-confirm-babel-evaluate-languages
:END:

#+vindex: org-extras-confirm-babel-evaluate-languages
A list of Org Babel language names (strings) for which
~org-extras-confirm-babel-evaluate~ will *not* prompt for confirmation.

* Commands
:PROPERTIES:
:CUSTOM_ID: h:commands
:END:

=org-extras.el= provides numerous interactive commands:

** Editing and Navigation
:PROPERTIES:
:CUSTOM_ID: h:editing-navigation
:END:

#+findex: org-extras-copy-heading-contents
~org-extras-copy-heading-contents~: Copies the text content of the heading at point (excluding subheadings) to the kill ring.
#+findex: org-extras-copy-heading-name
~org-extras-copy-heading-name~: Copies the heading title itself (without stars, TODO keywords, tags) to the kill ring.
#+findex: org-extras-count-words
~org-extras-count-words~: Counts words in the active region or the current subtree (excluding metadata and subheadings). Copies the count to the kill ring and messages the user.
#+findex: org-extras-goto-beginning-of-heading-text
~org-extras-goto-beginning-of-heading-text~: Moves point to the start of the heading text, after stars, TODO keyword, and priority.
#+findex: org-extras-inline-images
~org-extras-inline-images~: Toggles the display of inline images in the buffer. Accepts prefix arg for explicit enable/disable.
#+findex: org-extras-insert-subheading
~org-extras-insert-subheading~: Inserts a new demoted heading at the end of the current entry's body, but *before* any existing subheadings.
#+findex: org-extras-insert-todo-subheading-after-body
~org-extras-insert-todo-subheading-after-body~: Inserts a new demoted TODO heading at the very end of the current entry's body.
#+findex: org-extras-jump-to-first-heading
~org-extras-jump-to-first-heading~: Moves point to the beginning of the first heading in the buffer.
#+findex: org-extras-link-get-description-at-point
~org-extras-link-get-description-at-point~: Copies the description part of the Org link at point to the kill ring.
#+findex: org-extras-link-get-link-at-point
~org-extras-link-get-link-at-point~: Copies the full Org link syntax =[[url][desc]]= at point to the kill ring.
#+findex: org-extras-link-get-url-at-point
~org-extras-link-get-url-at-point~: Copies the URL part of the Org link at point to the kill ring.
#+findex: org-extras-paste-image
~org-extras-paste-image~: Pastes an image from the system clipboard into the Org buffer. Saves the image to a uniquely named file in =paths-dir-org-images=, inserts a file link, prompts for a caption, and displays inline images. Requires =pngpaste= utility.
#+findex: org-extras-paste-with-conversion
~org-extras-paste-with-conversion~: Pastes clipboard content, converting it from HTML or Markdown to Org format using Pandoc.
#+findex: org-extras-remove-link
~org-extras-remove-link~: Replaces the Org link at point with its description (or URL if description is empty).
#+findex: org-extras-set-todo-properties
~org-extras-set-todo-properties~: Interactively sets the priority (=org-priority=) and effort (=org-set-effort=) for the heading at point.
#+findex: org-extras-super-return
~org-extras-super-return~: If point is on a link, opens it using =eww= (by temporarily setting =browse-url-browser-function=). Otherwise, likely performs a standard RET action (though the code doesn't explicitly show the fallback).
#+findex: org-extras-url-dwim
~org-extras-url-dwim~: Copies the URL at point (either plain text URL or Org link target) to the kill ring.

** Agenda Management
:PROPERTIES:
:CUSTOM_ID: h:agenda-management
:END:

#+findex: org-extras-agenda-done-and-next
~org-extras-agenda-done-and-next~: Marks the agenda item at point as DONE, switches back to the agenda buffer, and moves to the next line. (Marked as a temporary command in comments).
#+findex: org-extras-agenda-goto-and-start-clock
~org-extras-agenda-goto-and-start-clock~: In the agenda buffer, jumps to the source location of the entry at point and clocks it in.
#+findex: org-extras-agenda-postpone-and-next
~org-extras-agenda-postpone-and-next~: Postpones the agenda item at point by one day and moves to the next line.
#+findex: org-extras-agenda-switch-to-agenda-current-day
~org-extras-agenda-switch-to-agenda-current-day~: Switches to the Org Agenda buffer for the current day, opening it in the left window (using window number 1 via =winum=) and creating the agenda view if necessary.
#+findex: org-extras-agenda-switch-to-dwim
~org-extras-agenda-switch-to-dwim~: If point is on an agenda log line, jumps to the corresponding clock entry in the source file. Otherwise, jumps to the heading of the agenda item at point.
#+findex: org-extras-agenda-toggle-anniversaries
~org-extras-agenda-toggle-anniversaries~: Toggles the display of BBDB anniversaries in the agenda by commenting/uncommenting the =%%(org-bbdb-anniversaries-future 1)= line under the heading specified by =org-extras-bbdb-anniversaries-heading=. Refreshes the agenda unless =just-enable= arg is non-nil.
#+findex: org-extras-agenda-toggle-log-mode
~org-extras-agenda-toggle-log-mode~: Toggles =org-agenda-log-mode= to show/hide clockcheck items.
#+findex: org-extras-unhighlight
~org-extras-unhighlight~: Calls =org-unhighlight= interactively to remove agenda highlighting.

** Clocking
:PROPERTIES:
:CUSTOM_ID: h:clocking
:END:

#+findex: org-extras-add-participants
~org-extras-add-participants~: Prompts (with completion using Org Roam "person" nodes) for participants and inserts them as a linked list (e.g., "Participants: [[id:ID1][Name1]], [[id:ID2][Name2]]") after the heading's metadata.
#+findex: org-extras-clock-report-insert
~org-extras-clock-report-insert~: Prompts for start date, end date, and scope (agenda, file, subtree), then inserts a =clocktable= dynamic block with the specified parameters and updates it.
#+findex: org-extras-delete-headings-without-logbook
~org-extras-delete-headings-without-logbook~: Deletes all headings in the current buffer that do *not* contain a =:LOGBOOK:= drawer. Prompts for confirmation.
#+findex: org-extras-jump-to-latest-clock-entry
~org-extras-jump-to-latest-clock-entry~: Shows the logbook for the current heading and jumps to the start time of the most recent CLOCK entry.
#+findex: org-extras-new-clock-entry-today
~org-extras-new-clock-entry-today~: Inserts a new CLOCK entry under the current heading with today's date, prompting for start and end times. Evaluates the time range afterwards.
#+findex: org-extras-time-stamp-active-current-date
~org-extras-time-stamp-active-current-date~: Inserts an active Org timestamp =<YYYY-MM-DD Day>= for the current date.
#+findex: org-extras-time-stamp-active-current-time
~org-extras-time-stamp-active-current-time~: Inserts an active Org timestamp =<YYYY-MM-DD Day HH:MM>= for the current time.
#+findex: org-extras-time-stamp-inactive-current-date
~org-extras-time-stamp-inactive-current-date~: Inserts an inactive Org timestamp =[YYYY-MM-DD Day]= for the current date.
#+findex: org-extras-time-stamp-inactive-current-time
~org-extras-time-stamp-inactive-current-time~: Inserts an inactive Org timestamp =[YYYY-MM-DD Day HH:MM]= for the current time.

** Folding and Cycling
:PROPERTIES:
:CUSTOM_ID: h:folding-cycling
:END:

#+findex: org-extras-cycle-global
~org-extras-cycle-global~: Cycles global visibility like =org-cycle-global= but also ensures archived subtrees remain hidden.
#+findex: org-extras-fold-show-all-headings
~org-extras-fold-show-all-headings~: Shows all heading content in the buffer, keeping archived subtrees hidden.
#+findex: org-extras-narrow-to-entry-and-children
~org-extras-narrow-to-entry-and-children~: Narrows the buffer to the current subtree (entry and all children) and ensures content is visible while drawers are hidden.
#+findex: org-extras-narrow-to-entry-no-children
~org-extras-narrow-to-entry-no-children~: Narrows the buffer to the current entry's heading and body text *only*, excluding any subheadings.
#+findex: org-extras-show-logbook
~org-extras-show-logbook~: Forces all logbook drawers to become visible (removes overlays added by =org-cycle-hide-drawers= or similar).
#+findex: org-extras-show-properties
~org-extras-show-properties~: Forces all property drawers to become visible (removes overlays added by =org-hide-properties-hide=).
#+findex: org-extras-show-subtree-hide-drawers
~org-extras-show-subtree-hide-drawers~: Shows the current entry and its children, but hides drawers within them.

** ID Management
:PROPERTIES:
:CUSTOM_ID: h:id-management
:END:

#+findex: org-extras-id-find-duplicate-ids
~org-extras-id-find-duplicate-ids~: Scans the =*Messages*= buffer for duplicate ID warnings (as produced by =org-id-update-id-locations=), collects the IDs and their associated file paths, and presents them in a new, read-only =*Duplicate Org IDs*= buffer. This allows for quick navigation to files containing duplicate IDs. In this buffer, pressing =SPC= executes =org-extras-id-process-next-duplicate=.
#+findex: org-extras-id-process-next-duplicate
~org-extras-id-process-next-duplicate~: From the =*Duplicate Org IDs*= buffer, this command opens the file corresponding to the first entry, widens the buffer, calls =simple-extras-visible-mode-enhanced= to make it easier to find the duplicate ID, copies the ID to the kill ring, and removes the line from the buffer. If the buffer becomes empty, it is automatically closed.
#+findex: org-extras-id-update-id-locations
~org-extras-id-update-id-locations~: Updates the Org ID location cache by scanning agenda files, archives, open Org files, files in =org-directory=, and =org-id-extra-files=. If any duplicate IDs are found during the scan, it automatically calls =org-extras-id-find-duplicate-ids= to present them in a separate buffer for review.

** List Handling
:PROPERTIES:
:CUSTOM_ID: h:list-handling
:END:

#+findex: org-extras-mark-checkbox-complete-and-move-to-next-item
~org-extras-mark-checkbox-complete-and-move-to-next-item~: Toggles the checkbox state at point (like =C-c C-c=) and then moves to the beginning of the next list item.
#+findex: org-extras-reset-checkbox-state-subtree
~org-extras-reset-checkbox-state-subtree~: Resets all checkboxes in the current subtree to incomplete (=[ ]=) and ensures the subtree is visible.

** Refiling
:PROPERTIES:
:CUSTOM_ID: h:refiling
:END:

#+findex: org-extras-refile-and-archive
~org-extras-refile-and-archive~: Refiles the current subtree (prompts for target), then archives the *original* subtree location to its archive sibling.
#+findex: org-extras-refile-goto-latest
~org-extras-refile-goto-latest~: Jumps to the location of the most recently refiled item (using =org-refile='s internal marker).
#+findex: org-extras-refile-regenerate-cache
~org-extras-refile-regenerate-cache~: Clears and regenerates the =org-refile= target cache.

** Babel and Encryption
:PROPERTIES:
:CUSTOM_ID: h:babel-encryption
:END:

#+findex: org-extras-babel-tangle
~org-extras-babel-tangle~: Widens the buffer, saves it, and then tangles it using =org-babel-tangle=.
#+findex: org-extras-crypt-dwim
~org-extras-crypt-dwim~: If point is on a clock line, evaluates the time range. Otherwise, decrypts the current entry using =org-decrypt-entry=.

** Sorting and Linkifying
:PROPERTIES:
:CUSTOM_ID: h:sorting-linkifying
:END:

#+findex: org-extras-sort-links
~org-extras-sort-links~: Sorts a list of Org links within the current paragraph, prompting for the SEPARATOR used between links.
#+findex: org-extras-sort-keywords
~org-extras-sort-keywords~: Sorts a list of Org links separated by " • " (specifically intended for keyword lists).

** External Integration
:PROPERTIES:
:CUSTOM_ID: h:external-integration
:END:

#+findex: org-extras-import-from-google-drive
~org-extras-import-from-google-drive~: Prompts for a Google Doc ID, downloads it as =.docx= using the =gdrive= CLI tool, converts it to Org format using Pandoc, and saves it in the downloads directory.

** Transient Menus
:PROPERTIES:
:CUSTOM_ID: h:transient-menus
:END:

#+findex: org-extras-config-dispatch
~org-extras-config-dispatch~: Transient menu for jumping to specific headings within the main =config.org= file.
#+findex: org-extras-personal-menu
~org-extras-personal-menu~: Transient menu for jumping to specific Org Roam nodes related to personal projects (finance, Anki, YouTube, etc.).
#+findex: org-extras-tlon-menu
~org-extras-tlon-menu~: Transient menu for jumping to specific Org Roam nodes related to "Tlön" projects (Babel, Uqbar, Utilitarianism, meetings, comms, etc.).

* Configuration Functions
:PROPERTIES:
:CUSTOM_ID: h:configuration-functions-org
:END:

- ~org-extras-capture-before-finalize-hook-function~: Function designed for =org-capture-before-finalize-hook=. Performs various actions based on the capture template key (:key in =org-capture-plist=), such as setting tags, changing dictionary, inserting links, prompting for renames, etc.
- ~org-extras-clocktable-sorter~: A function suitable for =org-clocktable-formatter=. Sorts the clock table entries by duration (descending) before formatting.
- ~org-extras-clock-in-add-participants~: Advice function added =:after= =org-clock-in=. Prompts for meeting participants (using Org Roam person nodes) and adds them to the heading, unless excluded by regexp or already present.
- ~org-extras-id-auto-add-ids-to-headings-in-file~: Function intended to be called from a hook (e.g., =find-file-hook= or =before-save-hook=). Automatically adds Org IDs (=org-id-get-create=) to headings that lack them, respecting various exclusion lists (directories, files, headings, file-local variable).
- ~org-extras-remove-trailing-heading~: Removes the last heading in the buffer if it's empty. Intended for use as a hook (e.g., =before-save-hook=) in specific directories like =gptel= notes.
- ~org-extras-confirm-babel-evaluate~: Function suitable for =org-confirm-babel-evaluate=. Returns non-nil (meaning *don't* prompt for confirmation) only for "python" and "emacs-lisp" code blocks.

* Utility Functions (Internal/Helpers)
:PROPERTIES:
:CUSTOM_ID: h:utility-functions-org
:END:

- ~org-extras-link-get-thing-at-point~: Extracts part of an Org link (full link, URL, or description) based on ARG.
- ~org-extras-get-heading-contents~: Returns the body text of the heading at point as a string.
- ~org-extras-productivity-of-the-day~: Calculates added/removed TODOs in agenda files since midnight using Git logs.
- ~org-extras-refile-at-position~: Helper to refile to a specific character POSITION in a file.
- ~org-extras-refile-to~: Helper to refile to a specific HEADING in a FILE.
- ~org-extras-linkify-elements~: Takes a list of STRINGS, finds corresponding Org Roam nodes, and returns a string of Org links separated by SEPARATOR.
- ~org-extras-eww-copy-for-org-mode~: Copies EWW buffer content/region, converting HTML formatting (links, bold, italic, lists) to Org syntax.
- ~org-extras-heading-has-participans-p~: Checks if the current heading already has a "Participants: " line.
- ~org-extras-make-image-filename~: Generates a unique filename for pasted images.

* Patched Functions
:PROPERTIES:
:CUSTOM_ID: h:patched-functions-org
:END:

- ~org-resolve-clocks~: Patched to use =org-agenda-files= instead of =org-files-list= when searching for clocks to resolve, potentially improving performance by limiting the search scope.
- ~org-check-agenda-file~: Patched to automatically remove non-existent files from =org-agenda-files= without prompting the user repeatedly.
- ~org-cite-insert~: Patched (commented out =org-cite--allowed-p= check) to potentially allow invoking citation insertion even in non-Org modes, possibly for use with Embark actions.

* Indices
:PROPERTIES:
:CUSTOM_ID: h:indices
:END:

** Function index
:PROPERTIES:
:INDEX: fn
:CUSTOM_ID: h:function-index
:END:

** Variable index
:PROPERTIES:
:INDEX: vr
:CUSTOM_ID: h:variable-index
:END:
